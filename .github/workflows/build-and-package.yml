# CI workflow: Build the Rust GDExtension library and package the game via
# Godot's export pipeline for Linux, Windows, macOS, Android, and iOS.
#
# Triggered manually via workflow_dispatch.
#
# Caveats:
# - Android: Exports a debug/unsigned APK. For release, add ANDROID_KEYSTORE_* secrets.
# - iOS: Exports an unsigned Xcode project. For App Store, add Apple signing secrets.
# - macOS: Not code-signed or notarized. Users will need to bypass Gatekeeper.
# - Mobile gdext: Experimental. If Android/iOS jobs fail, desktop builds still succeed.

name: Build & Package

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: "Create a GitHub Release with the built artifacts"
        required: false
        type: boolean
        default: false
      release_tag:
        description: "Release tag (e.g. v0.1.0). Leave blank for date-based."
        required: false
        type: string
        default: ""

env:
  GODOT_VERSION: "4.6.1"

jobs:
  # ---------------------------------------------------------------------------
  # Resolve version tag (runs in parallel with test)
  # ---------------------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Determine version tag
        id: tag
        run: |
          if [[ -z "${{ inputs.release_tag }}" ]]; then
            echo "tag=v$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ inputs.release_tag }}" >> "$GITHUB_OUTPUT"
          fi
          echo "Resolved tag: $(grep tag= "$GITHUB_OUTPUT" | tail -1)"

  # ---------------------------------------------------------------------------
  # Run sim tests before any builds
  # ---------------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run sim tests
        run: cargo test -p elven_canopy_sim

  # ---------------------------------------------------------------------------
  # Linux (x86_64)
  # ---------------------------------------------------------------------------
  build-linux:
    needs: [test, prepare]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: linux

      - name: Build GDExtension library
        run: cargo build --release -p elven_canopy_gdext

      - name: Install library for Godot
        run: |
          mkdir -p godot/target/release godot/target/debug
          cp target/release/libelven_canopy_gdext.so godot/target/release/
          cp target/release/libelven_canopy_gdext.so godot/target/debug/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import Godot project
        run: godot --headless --path godot --import --quit 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build/linux
          godot --headless --path godot --export-release "Linux" \
            "${GITHUB_WORKSPACE}/build/linux/elven-canopy.x86_64"

      - name: Create archive
        run: tar czf "elven-canopy-${{ needs.prepare.outputs.version_tag }}-linux-x86_64.tar.gz" -C build/linux .

      - uses: actions/upload-artifact@v4
        with:
          name: elven-canopy-${{ needs.prepare.outputs.version_tag }}-linux-x86_64
          path: "elven-canopy-${{ needs.prepare.outputs.version_tag }}-linux-x86_64.tar.gz"

  # ---------------------------------------------------------------------------
  # Windows (x86_64)
  # ---------------------------------------------------------------------------
  build-windows:
    needs: [test, prepare]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: windows

      - name: Build GDExtension library
        run: cargo build --release -p elven_canopy_gdext

      - name: Install library for Godot
        shell: bash
        run: |
          mkdir -p godot/target/release godot/target/debug
          cp target/release/elven_canopy_gdext.dll godot/target/release/
          cp target/release/elven_canopy_gdext.dll godot/target/debug/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import Godot project
        shell: bash
        run: godot --headless --path godot --import --quit 2>&1 || true

      - name: Export game
        shell: bash
        run: |
          mkdir -p build/windows
          godot --headless --path godot --export-release "Windows" \
            "${GITHUB_WORKSPACE}/build/windows/elven-canopy.exe"

      - name: Create archive
        shell: bash
        run: 7z a "elven-canopy-${{ needs.prepare.outputs.version_tag }}-windows-x86_64.zip" ./build/windows/*

      - uses: actions/upload-artifact@v4
        with:
          name: elven-canopy-${{ needs.prepare.outputs.version_tag }}-windows-x86_64
          path: "elven-canopy-${{ needs.prepare.outputs.version_tag }}-windows-x86_64.zip"

  # ---------------------------------------------------------------------------
  # macOS (universal: aarch64 + x86_64)
  # ---------------------------------------------------------------------------
  build-macos:
    needs: [test, prepare]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          key: macos

      - name: Build GDExtension library (aarch64)
        run: cargo build --release -p elven_canopy_gdext --target aarch64-apple-darwin

      - name: Build GDExtension library (x86_64)
        run: cargo build --release -p elven_canopy_gdext --target x86_64-apple-darwin

      - name: Create universal binary
        run: |
          mkdir -p target/release
          lipo -create \
            target/aarch64-apple-darwin/release/libelven_canopy_gdext.dylib \
            target/x86_64-apple-darwin/release/libelven_canopy_gdext.dylib \
            -output target/release/libelven_canopy_gdext.dylib

      - name: Install library for Godot
        run: |
          mkdir -p godot/target/release godot/target/debug
          cp target/release/libelven_canopy_gdext.dylib godot/target/release/
          cp target/release/libelven_canopy_gdext.dylib godot/target/debug/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import Godot project
        run: godot --headless --path godot --import --quit 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build/macos
          godot --headless --path godot --export-release "macOS" \
            "${GITHUB_WORKSPACE}/build/macos/ElvenCanopy.app"

      - name: Create archive
        run: cd build/macos && zip -ry "../../elven-canopy-${{ needs.prepare.outputs.version_tag }}-macos-universal.zip" ElvenCanopy.app

      - uses: actions/upload-artifact@v4
        with:
          name: elven-canopy-${{ needs.prepare.outputs.version_tag }}-macos-universal
          path: "elven-canopy-${{ needs.prepare.outputs.version_tag }}-macos-universal.zip"

  # ---------------------------------------------------------------------------
  # Android (arm64-v8a) — debug/unsigned APK
  # ---------------------------------------------------------------------------
  build-android:
    needs: [test, prepare]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
      - uses: Swatinem/rust-cache@v2
        with:
          key: android
      - uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: sdkmanager "ndk;27.0.12077973"

      - name: Create debug keystore
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v -keystore ~/.android/debug.keystore \
              -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build GDExtension library with cargo-ndk
        run: |
          cargo install cargo-ndk
          cargo ndk -t arm64-v8a build --release -p elven_canopy_gdext
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/27.0.12077973

      - name: Install library for Godot
        run: |
          mkdir -p godot/target/aarch64-linux-android/release godot/target/aarch64-linux-android/debug
          cp target/aarch64-linux-android/release/libelven_canopy_gdext.so godot/target/aarch64-linux-android/release/
          cp target/aarch64-linux-android/release/libelven_canopy_gdext.so godot/target/aarch64-linux-android/debug/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Configure Godot editor settings for Android
        run: |
          GODOT_CONFIG="${HOME}/.config/godot"
          mkdir -p "${GODOT_CONFIG}"
          cat > "${GODOT_CONFIG}/editor_settings-4.tres" << 'EOF'
          [gd_resource type="EditorSettings" format=3]

          [resource]
          export/android/android_sdk_path = "/usr/local/lib/android/sdk"
          export/android/debug_keystore = "/home/runner/.android/debug.keystore"
          export/android/debug_keystore_user = "androiddebugkey"
          export/android/debug_keystore_pass = "android"
          EOF

      - name: Import Godot project
        run: godot --headless --path godot --import --quit 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build/android
          godot --headless --path godot --export-debug "Android" \
            "${GITHUB_WORKSPACE}/build/android/elven-canopy.apk"

      - name: Rename APK with version
        run: cp build/android/elven-canopy.apk "elven-canopy-${{ needs.prepare.outputs.version_tag }}-android-arm64.apk"

      - uses: actions/upload-artifact@v4
        with:
          name: elven-canopy-${{ needs.prepare.outputs.version_tag }}-android-arm64
          path: "elven-canopy-${{ needs.prepare.outputs.version_tag }}-android-arm64.apk"

  # ---------------------------------------------------------------------------
  # iOS (arm64) — unsigned Xcode project
  # ---------------------------------------------------------------------------
  build-ios:
    needs: [test, prepare]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios
      - uses: Swatinem/rust-cache@v2
        with:
          key: ios

      - name: Build GDExtension library
        run: cargo build --release -p elven_canopy_gdext --target aarch64-apple-ios

      - name: Create .framework bundle
        run: |
          FW="target/aarch64-apple-ios/release/elven_canopy_gdext.framework"
          mkdir -p "${FW}"
          cp target/aarch64-apple-ios/release/libelven_canopy_gdext.dylib \
            "${FW}/elven_canopy_gdext"
          cat > "${FW}/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>elven_canopy_gdext</string>
            <key>CFBundleIdentifier</key>
            <string>com.elvencanopy.gdext</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
            <key>MinimumOSVersion</key>
            <string>12.0</string>
          </dict>
          </plist>
          PLIST

      - name: Install library for Godot
        run: |
          mkdir -p godot/target/aarch64-apple-ios/release godot/target/aarch64-apple-ios/debug
          cp -R target/aarch64-apple-ios/release/elven_canopy_gdext.framework godot/target/aarch64-apple-ios/release/
          cp -R target/aarch64-apple-ios/release/elven_canopy_gdext.framework godot/target/aarch64-apple-ios/debug/

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import Godot project
        run: godot --headless --path godot --import --quit 2>&1 || true

      - name: Export game
        run: |
          mkdir -p build/ios
          godot --headless --path godot --export-release "iOS" \
            "${GITHUB_WORKSPACE}/build/ios/elven-canopy.xcodeproj"

      - name: Create archive
        run: cd build && zip -r "../elven-canopy-${{ needs.prepare.outputs.version_tag }}-ios-arm64.zip" ios/

      - uses: actions/upload-artifact@v4
        with:
          name: elven-canopy-${{ needs.prepare.outputs.version_tag }}-ios-arm64
          path: "elven-canopy-${{ needs.prepare.outputs.version_tag }}-ios-arm64.zip"

  # ---------------------------------------------------------------------------
  # Create GitHub Release (optional)
  # ---------------------------------------------------------------------------
  release:
    if: ${{ inputs.create_release }}
    needs: [prepare, build-linux, build-windows, build-macos, build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -lh artifacts/

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.prepare.outputs.version_tag }}"
          gh release create "$TAG" \
            --repo "${{ github.repository }}" \
            --title "Elven Canopy $TAG" \
            --generate-notes \
            artifacts/elven-canopy-*
